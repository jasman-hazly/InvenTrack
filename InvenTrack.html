<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Inventory Tracker (Local Storage)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 sm:p-8 min-h-screen">

    <div id="app-content" class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <header class="mb-6 p-6 bg-white rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">Offline Inventory Tracker</h1>
            <p class="text-sm text-gray-500 mb-4">
                Data is saved to your browser's <strong>Local Storage</strong>.
            </p>
            
            <div class="flex flex-wrap items-center gap-4">
                <label class="relative inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer transition-colors">
                    <span id="upload-btn-text">Upload CSV</span>
                    <input type="file" id="csv-upload" class="absolute left-0 top-0 w-full h-full opacity-0 cursor-pointer" accept=".csv">
                </label>
                
                <button onclick="clearData()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Clear All Data
                </button>

                <span id="upload-message" class="text-emerald-600 text-sm font-medium hidden"></span>
            </div>
            <p id="error-message" class="text-red-500 text-sm mt-4 hidden"></p>
        </header>

        <!-- Dashboard -->
        <div class="mb-6 p-6 bg-white rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">
                Dashboard: <span id="dashboard-category-title" class="text-indigo-600">Overall</span>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-100 rounded-lg text-center">
                    <span id="stat-total" class="text-3xl font-bold text-blue-800">0</span>
                    <p class="text-sm font-medium text-blue-700">Total Items</p>
                </div>
                <div class="p-4 bg-red-100 rounded-lg text-center">
                    <span id="stat-taken" class="text-3xl font-bold text-red-800">0</span>
                    <p class="text-sm font-medium text-red-700">Items Taken</p>
                </div>
                <div class="p-4 bg-emerald-100 rounded-lg text-center">
                    <span id="stat-nottaken" class="text-3xl font-bold text-emerald-800">0</span>
                    <p class="text-sm font-medium text-emerald-700">Items Not Taken</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mb-4 p-4 bg-white rounded-lg shadow-lg">
            <h3 class="text-lg font-medium mb-3">Filter by Category</h3>
            <div id="category-filters" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- List -->
        <main class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold">
                    Item List (<span id="item-count">0</span>)
                </h2>
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Search by name..." 
                    class="w-full mt-4 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
            </div>
            
            <ul id="inventory-list" class="divide-y divide-gray-200"></ul>
            <div id="empty-state" class="p-6 text-center text-gray-500 hidden">
                No items found. Upload a CSV to get started.
            </div>
        </main>

    </div>

    <!-- Application Logic -->
    <script>
        // --- State ---
        const STORAGE_KEY = 'inventory_data_v1';
        
        const state = {
            items: [],
            categories: ['All'],
            selectedCategory: 'All',
            searchQuery: '',
            uploading: false
        };

        const els = {
            uploadBtnText: document.getElementById('upload-btn-text'),
            csvInput: document.getElementById('csv-upload'),
            uploadMsg: document.getElementById('upload-message'),
            errorMsg: document.getElementById('error-message'),
            dashboardTitle: document.getElementById('dashboard-category-title'),
            statTotal: document.getElementById('stat-total'),
            statTaken: document.getElementById('stat-taken'),
            statNotTaken: document.getElementById('stat-nottaken'),
            filterContainer: document.getElementById('category-filters'),
            itemCount: document.getElementById('item-count'),
            searchInput: document.getElementById('search-input'),
            inventoryList: document.getElementById('inventory-list'),
            emptyState: document.getElementById('empty-state')
        };

        // --- Initialization ---
        function init() {
            loadFromStorage();
            renderAll();
        }

        // --- Local Storage Logic ---
        function loadFromStorage() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                try {
                    state.items = JSON.parse(raw);
                    updateCategories();
                } catch (e) {
                    console.error("Failed to parse local storage", e);
                    state.items = [];
                }
            }
        }

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items));
            updateCategories();
            renderAll();
        }

        function updateCategories() {
            const cats = new Set(['All']);
            state.items.forEach(i => cats.add(i.category));
            state.categories = Array.from(cats);
        }

        function clearData() {
            if(confirm("Are you sure you want to delete all data?")) {
                state.items = [];
                state.categories = ['All'];
                state.selectedCategory = 'All';
                saveToStorage();
                // Clear the UI
                state.items = []; 
                renderAll();
            }
        }
        window.clearData = clearData; // Expose to global scope

        // --- Logic: Rendering ---
        function renderAll() {
            renderFilters();
            renderDashboard();
            renderList();
        }

        function renderFilters() {
            els.filterContainer.innerHTML = '';
            state.categories.forEach(cat => {
                const btn = document.createElement('button');
                const isActive = state.selectedCategory === cat;
                
                const baseClasses = "px-4 py-2 text-sm font-medium rounded-full transition-all duration-150";
                const activeClasses = "bg-indigo-600 text-white shadow-md";
                const inactiveClasses = "bg-gray-200 text-gray-700 hover:bg-gray-300";
                
                btn.className = `${baseClasses} ${isActive ? activeClasses : inactiveClasses}`;
                btn.textContent = cat;
                btn.onclick = () => {
                    state.selectedCategory = cat;
                    renderAll();
                };
                els.filterContainer.appendChild(btn);
            });
        }

        function renderDashboard() {
            const relevantItems = state.selectedCategory === 'All' 
                ? state.items 
                : state.items.filter(i => i.category === state.selectedCategory);

            const total = relevantItems.length;
            const taken = relevantItems.filter(i => i.taken).length;
            const notTaken = total - taken;

            els.dashboardTitle.textContent = state.selectedCategory === 'All' ? 'Overall' : state.selectedCategory;
            els.statTotal.textContent = total;
            els.statTaken.textContent = taken;
            els.statNotTaken.textContent = notTaken;
        }

        function renderList() {
            let filtered = state.selectedCategory === 'All' 
                ? state.items 
                : state.items.filter(i => i.category === state.selectedCategory);

            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(i => i.name.toLowerCase().includes(q));
            }

            els.itemCount.textContent = filtered.length;
            els.inventoryList.innerHTML = '';

            if (filtered.length === 0) {
                els.emptyState.classList.remove('hidden');
                return;
            }
            els.emptyState.classList.add('hidden');

            filtered.forEach(item => {
                const li = document.createElement('li');
                li.className = `p-4 flex items-center justify-between transition-all ${item.taken ? 'opacity-60 bg-gray-50' : 'bg-white'}`;
                
                const showCategory = state.selectedCategory === 'All';
                
                li.innerHTML = `
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-900">${esc(item.name)}</h3>
                        ${showCategory ? `<p class="text-sm text-gray-500">${esc(item.category)}</p>` : ''}
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <button 
                            class="px-4 py-2 text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 
                            ${item.taken 
                                ? 'text-gray-700 bg-gray-200 hover:bg-gray-300 focus:ring-gray-400' 
                                : 'text-white bg-teal-600 hover:bg-teal-700 focus:ring-teal-500'}"
                            onclick="window.toggleItem('${item.id}')"
                        >
                            ${item.taken ? 'Return' : 'Take Item'}
                        </button>
                    </div>
                `;
                els.inventoryList.appendChild(li);
            });
        }

        // --- Logic: Actions ---
        window.toggleItem = (id) => {
            const itemIndex = state.items.findIndex(i => i.id === id);
            if (itemIndex > -1) {
                state.items[itemIndex].taken = !state.items[itemIndex].taken;
                saveToStorage(); // Persist changes
            }
        };

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const nameIdx = headers.indexOf('name');
            const catIdx = headers.indexOf('category');
            
            if (nameIdx === -1 || catIdx === -1) throw new Error("CSV must have 'name' and 'category' headers.");

            const result = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const cols = lines[i].split(',');
                const name = cols[nameIdx]?.trim();
                const category = cols[catIdx]?.trim() || 'Uncategorized';
                if (name) {
                    // Generate a simple random ID for local use
                    const id = 'local_' + Math.random().toString(36).substr(2, 9);
                    result.push({ id, name, category, taken: false });
                }
            }
            return result;
        }

        els.csvInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            setUploading(true);
            showError(null); 
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const newItems = parseCSV(evt.target.result);
                    if (newItems.length === 0) throw new Error("No valid items found.");

                    // Overwrite existing items
                    state.items = newItems;
                    saveToStorage();

                    showSuccess(`Successfully uploaded ${newItems.length} items!`);
                    e.target.value = ''; 
                } catch (err) {
                    console.error(err);
                    showError(err.message);
                } finally {
                    setUploading(false);
                }
            };
            reader.readAsText(file);
        });

        els.searchInput.addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderList();
        });

        // --- Helpers ---
        function setUploading(isUploading) {
            state.uploading = isUploading;
            els.uploadBtnText.textContent = isUploading ? 'Uploading...' : 'Upload CSV';
            els.csvInput.disabled = isUploading;
        }

        function showSuccess(msg) {
            els.uploadMsg.textContent = msg;
            els.uploadMsg.classList.remove('hidden');
            setTimeout(() => els.uploadMsg.classList.add('hidden'), 5000);
        }

        function showError(msg) {
            if (msg) {
                els.errorMsg.textContent = msg;
                els.errorMsg.classList.remove('hidden');
            } else {
                els.errorMsg.classList.add('hidden');
            }
        }

        function esc(str) {
            if (!str) return '';
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Start App
        init();
    </script>
</body>
</html>
